openapi: 3.0.3

info:
  title: PreFix – Maintenance Management API
  version: "1.0.0"
  description: |
    API per la gestione della manutenzione degli edifici comunali.

    **Sicurezza**
    - Tutte le API `/api/v1/*` sono **protette**
    - L’autenticazione reale è gestita da **Proxy + Cookie HTTP-only**
    - L’autorizzazione è gestita tramite **RBAC (Policy Decision Point)**
    - Swagger utilizza **Bearer Token SOLO per documentazione/test manuale**

    Swagger **NON** gestisce correttamente i cookie HTTP-only.
    Per questo motivo:
    - Effettuare il login tramite Postman / Curl / Frontend
    - Inserire manualmente un access token nel pulsante **Authorize** (solo per test)

    **Ruoli**
    - Utente registrato
    - Utente secondario
    - Admin locale
    - Admin centrale
    - Impresa

servers:
  - url: http://localhost:5000
    description: Proxy API Gateway

# Tutte le API sono protette di default
security:
  - BearerAuth: []

tags:
  - name: Auth
  - name: Users
  - name: Buildings
  - name: Events
  - name: Interventions
  - name: Requests
  - name: Notifications

paths:

  # =====================
  # AUTH (PUBBLICHE)
  # =====================
  /auth/register:
    post:
      security: []
      tags: [Auth]
      summary: Registrazione utente
      description: |
        Registra un nuovo utente.
        Stato iniziale: **pending**
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRegister"
      responses:
        "201":
          description: Utente registrato
        "400":
          description: Dati non validi

  /auth/login:
    post:
      security: []
      tags: [Auth]
      summary: Login utente
      description: Login basato su cookie HTTP-only
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLogin"
      responses:
        "200":
          description: Login effettuato
        "401":
          description: Credenziali non valide

  /auth/logout:
    post:
      security: []
      tags: [Auth]
      summary: Logout utente
      responses:
        "200":
          description: Logout effettuato

  /auth/me:
    get:
      tags: [Auth]
      summary: Utente corrente
      description: |
        **Ruolo richiesto:** Utente registrato
        Restituisce i dettagli dell'utente corrente
      responses:
        "200":
          description: Dati utente loggato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Non autenticato


  # =====================
  # USERS
  # =====================
  /api/v1/users:
    get:
      tags: [Users]
      summary: Lista utenti
      description: |
        **Ruolo richiesto:** Admin Centrale
        Restituisce la lista di tutti gli utenti
      responses:
        "200":
          description: Lista utenti
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
        "401":
          description: Non autenticato
        "403":
          description: Accesso negato

  /api/v1/users/me:
    get:
      tags: [Users]
      summary: Profilo utente
      description: |
        **Ruolo richiesto:** Utente registrato
        Restituisce i dettagli area personale dell'utente corrente
      responses:
        "200":
          description: Profilo utente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Non autenticato

  /api/v1/users/pending:
    get:
      tags: [Users]
      summary: Utenti in attesa
      description: |
        **Ruolo richiesto:** Admin Centrale
        Restituisce la lista di tutti gli utenti in stato di pending
      responses:
        "200":
          description: Utenti pending
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
        "401":
          description: Non autenticato
        "403":
          description: Accesso negato

  /api/v1/users/{id}/assign-role:
    put:
      tags: [Users]
      summary: Assegna ruolo
      description: |
        **Ruolo richiesto:** Admin Centrale
        Assegna un ruolo ad un particolare utente
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role:
                  type: string
      responses:
        "200":
          description: Ruolo assegnato
        "401":
          description: Non autenticato
        "403":
          description: Accesso negato
        "404":
          description: Utente non trovato

  /api/v1/users/{id}/assign-building:
    put:
      tags: [Users]
      summary: Assegna edifici
      description: |
        **Ruolo richiesto:** Admin Centrale
        Assegna un edificio ad un particolare utente
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [buildingIds]
              properties:
                buildingIds:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: Edifici assegnati
        "401":
          description: Non autenticato
        "403":
          description: Accesso negato
        "404":
          description: Utente non trovato


  # =====================
  # BUILDINGS
  # =====================
  /api/v1/buildings:
    get:
      tags: [Buildings]
      summary: Edifici associati
      description: |
        **Ruolo richiesto:** Utente registrato
        Restituisce tutti i buildings a cui un utente è associato
      responses:
        "200":
          description: Lista edifici
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Building"
        "401":
          description: Non autenticato
        "403":
          description: Accesso negato


  # =====================
  # EVENTS
  # =====================
  /api/v1/events:
    get:
      tags: [Events]
      summary: Lista eventi
      description: |
        **Ruolo richiesto:** Utente registrato
        Restituisce gli eventi di manutenzione associati agli edifici dell’utente.

        ### Filtro per edificio
        - Se `buildingId` non è specificato → eventi di **tutti** gli edifici associati all’utente
        - Se `buildingId` è specificato → eventi **solo** di quell’edificio

        ### Vista calendario
        - `type=calendar` restituisce solo eventi pianificati (`scheduledAt != null`)
      parameters:
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [calendar, future]
          description: |
            Vista degli eventi:
            - assente → registro completo
            - calendar → eventi pianificati
            - future → solo eventi futuri (scheduledAt >= now)

        - name: buildingId
          in: query
          required: false
          schema:
            type: string
          description: ID dell’edificio
      responses:
        "200":
          description: Lista eventi
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Event"
        "401":
          description: Non autenticato
        "403":
          description: Accesso non autorizzato all’edificio


  /api/v1/events/{id}:
    get:
      tags: [Events]
      summary: Dettaglio evento
      description: |
        **Ruolo richiesto:** Utente registrato
        Restituisce il dettaglio di un singolo evento
      parameters:
        - $ref: "#/components/parameters/EventId"
      responses:
        "200":
          description: Evento
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "401":
          description: Non autenticato
        "404":
          description: Evento non trovato


# =====================
# INTERVENTIONS
# =====================
  /api/v1/interventions:
    get:
      tags: [Interventions]
      summary: Storico interventi
      description: |
        **Ruolo richiesto:** Utente registrato
        Restituisce lo storico degli interventi associati agli edifici dell’utente.

        ### Modalità di utilizzo
        - **Senza parametri:** tutti gli interventi (storico completo)
        - **Con `period`:** interventi filtrati per periodo
        - **Con `assetId`:** interventi relativi a uno specifico asset
        - **Con `buildingId`:** interventi relativi a uno specifico edificio
        - **Parametri combinabili**

        ### Sicurezza
        Se viene passato `buildingId`, deve appartenere agli edifici associati all’utente.
      parameters:
        - name: buildingId
          in: query
          required: false
          description: |
            ID dell’edificio per filtrare gli interventi.
            Deve essere uno degli edifici associati all’utente.
          schema:
            type: string

        - name: assetId
          in: query
          required: false
          description: ID dell’asset per filtrare gli interventi
          schema:
            type: string

        - name: period
          in: query
          required: false
          description: |
            Filtro temporale sugli interventi.
            Valori ammessi:
            - `month` → ultimo mese
            - `quarter` → ultimo trimestre
            - `year` → ultimo anno
          schema:
            type: string
            enum: [month, quarter, year]

      responses:
        "200":
          description: Lista interventi
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Intervention"
        "400":
          description: Parametri non validi
        "401":
          description: Non autenticato
        "403":
          description: Non autorizzato


  /api/v1/interventions/{id}:
    get:
      tags: [Interventions]
      summary: Dettaglio intervento
      description: |
        Restituisce il dettaglio di un singolo intervento.
      parameters:
        - $ref: "#/components/parameters/InterventionId"
      responses:
        "200":
          description: Dettaglio intervento
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Intervention"

        "401":
          description: Non autenticato
        "403":
          description: Non autorizzato
        "404":
          description: Intervento non trovato


# =====================
# REQUESTS
# =====================
  /api/v1/requests:
    get:
      tags: [Requests]
      summary: Lista richieste
      description: |
        **Ruolo richiesto:** Admin Centrale
        Restituisce la lista di tutte le richieste presenti nel sistema.
      responses:
        "200":
          description: Lista richieste
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Request"
        "401":
          description: Non autenticato
        "403":
          description: Non autorizzato

  /api/v1/requests/{id}:
    get:
      tags: [Requests]
      summary: Dettaglio richiesta
      description: |
        Restituisce il dettaglio di una singola richiesta.
      parameters:
        - $ref: "#/components/parameters/RequestId"
      responses:
        "200":
          description: Dettaglio richiesta
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Request"
        "401":
          description: Non autenticato
        "403":
          description: Non autorizzato
        "404":
          description: Richiesta non trovata

  /api/v1/requests/assign-role:
    post:
      tags: [Requests]
      summary: Richiesta assegnazione ruolo
      description: |
        **Ruolo richiesto:** Utente secondario
        Permette a un utente di inviare una richiesta
        per l’assegnazione di un ruolo.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AssignRoleRequest"
      responses:
        "201":
          description: Richiesta creata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Request"
        "400":
          description: Payload non valido
        "401":
          description: Non autenticato
        "403":
          description: Non autorizzato

  /api/v1/requests/assign-building:
    post:
      tags: [Requests]
      summary: Richiesta assegnazione edificio
      description: |
        **Ruolo richiesto:** Utente secondario
        Permette a un utente di inviare una richiesta
        per l’assegnazione a un edificio.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AssignBuildingRequest"
      responses:
        "201":
          description: Richiesta creata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Request"
        "400":
          description: Payload non valido
        "401":
          description: Non autenticato
        "403":
          description: Non autorizzato


  # =====================
  # NOTIFICATIONS
  # =====================
  /api/v1/notifications:
    get:
      tags: [Notifications]
      summary: Notifiche utente
      description: |
        **Ruolo richiesto:** Utente registrato
      parameters:
        - name: not_read
          in: query
          required: false
          schema:
            type: boolean
          description: |
            Se true, restituisce solo le notifiche non lette
      responses:
        "200":
          description: Lista notifiche
        "401":
          description: Non autenticato

  /api/v1/notifications/{id}/read:
    patch:
      tags: [Notifications]
      summary: Segna come letta
      description: |
        **Ruolo richiesto:** Utente registrato
        Segna una particolare notifica come letta
      parameters:
        - $ref: "#/components/parameters/NotificationId"
      responses:
        "200":
          description: Notifica aggiornata
        "401":
          description: Non autenticato

  /api/v1/notifications/read-all:
    patch:
      tags: [Notifications]
      summary: Segna tutte come lette
      description: |
        **Ruolo richiesto:** Utente registrato
        Segna tutte le notifiche come lette
      responses:
        "200":
          description: OK
        "401":
          description: Non autenticato


components:

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Inserire l'access token JWT.
        Usato SOLO per test su Swagger UI.

  parameters:
    UserId:
      name: id
      in: path
      required: true
      schema:
        type: string

    EventId:
      name: id
      in: path
      required: true
      schema:
        type: string

    InterventionId:
      name: id
      in: path
      required: true
      schema:
        type: string

    RequestId:
      name: id
      in: path
      required: true
      schema:
        type: string

    NotificationId:
      name: id
      in: path
      required: true
      schema:
        type: string

  schemas:
    AuthRegister:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    AuthLogin:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    User:
      type: object
      properties:
        _id:
          type: string
        email:
          type: string
        role:
          type: string
        status:
          type: string

    Building:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string

    Event:
      type: object
      properties:
        _id:
          type: string
        assetId:
          type: string
        status:
          type: string
        scheduledAt:
          type: string
          format: date-time

    Intervention:
      type: object
      properties:
        _id:
          type: string

        assetId:
          type: string
          description: Asset associato all’intervento

        type:
          type: string
          enum: [maintenance, inspection, failure, repair]

        outcome:
          type: string
          enum: [ok, ko, partial]

        severity:
          type: string
          enum: [low, medium, high]

        description:
          type: string

        performedAt:
          type: string
          format: date-time

        durationMinutes:
          type: number
          description: Durata intervento in minuti

        calendarEventId:
          type: string
          nullable: true

        createdAt:
          type: string
          format: date-time

        updatedAt:
          type: string
          format: date-time

    Request:
      type: object
      properties:
        _id:
          type: string
        requestType:
          type: string
          enum: [ASSIGN_ROLE, ASSIGN_BUILDING]
        userId:
          type: string
        role:
          type: string
          nullable: true
        buildingId:
          type: string
          nullable: true
        status:
          type: string
          enum: [PENDING, APPROVED, REJECTED]
        createdAt:
          type: string
          format: date-time

    AssignRoleRequest:
      type: object
      required:
        - requestType
        - userId
        - role
      properties:
        requestType:
          type: string
          enum: [ASSIGN_ROLE]
        userId:
          type: string
          description: ID dell’utente che richiede il ruolo
        role:
          type: string
          description: Ruolo richiesto dall’utente

    AssignBuildingRequest:
      type: object
      required:
        - requestType
        - userId
        - buildingId
      properties:
        requestType:
          type: string
          enum: [ASSIGN_BUILDING]
        userId:
          type: string
          description: ID dell’utente che richiede l’assegnazione
        buildingId:
          type: string
          description: ID dell’edificio richiesto

    Notification:
      type: object
      properties:
        _id:
          type: string
        message:
          type: string
        read:
          type: boolean
