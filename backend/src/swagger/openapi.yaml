openapi: 3.0.3

info:
  title: PreFix – Maintenance Management API
  description: |
    API per la gestione della manutenzione degli edifici comunali.

    **Sicurezza**
    - Tutte le API `/api/v1/*` sono protette
    - Autenticazione reale gestita da Proxy + Cookie + RBAC
    - Swagger usa Bearer Token SOLO per documentazione/test

    **Ruoli**
    - Utente registrato
    - Utente secondario
    - Admin locale
    - Admin centrale
    - Impresa

    **Funzionamento**
    - Effettuare il login di un utente già registrato, tramite Postman o Curl, ed inserire l'acccessToken (di validità breve) sulla form che appare al click del bottone "Authorize" per effettuare le API.
    - `Motivo:` Swagger UI NON gestisce bene cookie HTTP-only. Se si prova ad effettuare un'API pubblica si resta in attesa all'infinito, poichè viene salvato il refreshToken all'interno di un cookie HTTP-only.
  version: "1.0.0"

servers:
  - url: http://localhost:5000
    description: Proxy API Gateway

# Tutte le API sono protette di default
security:
  - BearerAuth: []

tags:
  - name: Auth
  - name: Users
  - name: Buildings
  - name: Events
  - name: Interventions
  - name: Calendar
  - name: Requests
  - name: Notifications
  - name: Dashboard

paths:

  # =====================
  # AUTH (PUBBLICHE)
  # =====================
  /auth/register:
    post:
      security: []
      tags: [Auth]
      summary: Registrazione utente
      description: |
        Registra un nuovo utente.
        Ruolo iniziale: **pending**
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRegister"
      responses:
        "201":
          description: Utente registrato

  /auth/login:
    post:
      security: []
      tags: [Auth]
      summary: Login utente
      description: Login (cookie-based)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLogin"
      responses:
        "200":
          description: Login effettuato

  /auth/logout:
    post:
      security: []
      tags: [Auth]
      summary: Logout
      responses:
        "200":
          description: Logout effettuato

  /auth/me:
    get:
      tags: [Auth]
      summary: Utente corrente
      responses:
        "200":
          description: Dati utente loggato
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  # =====================
  # USERS
  # =====================
  /api/v1/users:
    get:
      tags: [Users]
      summary: Lista utenti
      description: |
        **Admin Centrale**
      responses:
        "200":
          description: Lista utenti
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"

  /api/v1/users/me:
    get:
      tags: [Users]
      summary: Profilo utente
      description: |
        Utente registrato
      responses:
        "200":
          description: Profilo utente
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  /api/v1/users/pending:
    get:
      tags: [Users]
      summary: Utenti in attesa
      description: |
        **Admin Centrale**
      responses:
        "200":
          description: Utenti pending
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"

  /api/v1/users/{id}/assign-role:
    put:
      tags: [Users]
      summary: Assegna ruolo
      description: |
        **Admin Centrale**
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role:
                  type: string
      responses:
        "200":
          description: Ruolo assegnato

  /api/v1/users/{id}/assign-building:
    put:
      tags: [Users]
      summary: Assegna edifici
      description: |
        **Admin Centrale**
      parameters:
        - $ref: "#/components/parameters/UserId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [buildingIds]
              properties:
                buildingIds:
                  type: array
                  items:
                    type: string
      responses:
        "200":
          description: Edifici assegnati

  # =====================
  # BUILDINGS
  # =====================
  /api/v1/buildings:
    get:
      tags: [Buildings]
      summary: Edifici associati
      description: |
        Utente registrato
      responses:
        "200":
          description: Lista edifici
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Building"

  # =====================
  # EVENTS
  # =====================
  /api/v1/events:
    get:
      tags: [Events]
      summary: Lista eventi
      description: |
        Utente registrato
      responses:
        "200":
          description: Lista eventi
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Event"

  /api/v1/events/{id}:
    get:
      tags: [Events]
      summary: Dettaglio evento
      parameters:
        - $ref: "#/components/parameters/EventId"
      responses:
        "200":
          description: Evento
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"

  # =====================
  # INTERVENTIONS
  # =====================
  /api/v1/interventions:
    get:
      tags: [Interventions]
      summary: Storico interventi
      responses:
        "200":
          description: Interventi
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Intervention"

  /api/v1/interventions/{id}:
    get:
      tags: [Interventions]
      summary: Dettaglio intervento
      parameters:
        - $ref: "#/components/parameters/InterventionId"
      responses:
        "200":
          description: Intervento
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Intervention"

  # =====================
  # CALENDAR
  # =====================
  /api/v1/calendar:
    get:
      tags: [Calendar]
      summary: Calendario manutenzioni
      responses:
        "200":
          description: Eventi calendarizzati
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Event"

  # =====================
  # NOTIFICATIONS
  # =====================
  /api/v1/notifications:
    get:
      tags: [Notifications]
      summary: Notifiche utente
      responses:
        "200":
          description: Notifiche
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Notification"

  /api/v1/notifications/{id}/read:
    patch:
      tags: [Notifications]
      summary: Segna come letta
      parameters:
        - $ref: "#/components/parameters/NotificationId"
      responses:
        "200":
          description: Notifica aggiornata

  /api/v1/notifications/read-all:
    patch:
      tags: [Notifications]
      summary: Segna tutte come lette
      responses:
        "200":
          description: OK

components:

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token usato solo per Swagger

  parameters:
    UserId:
      name: id
      in: path
      required: true
      schema:
        type: string

    EventId:
      name: id
      in: path
      required: true
      schema:
        type: string

    InterventionId:
      name: id
      in: path
      required: true
      schema:
        type: string

    NotificationId:
      name: id
      in: path
      required: true
      schema:
        type: string

  schemas:
    AuthRegister:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    AuthLogin:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    User:
      type: object
      properties:
        _id:
          type: string
        email:
          type: string
        role:
          type: string
        status:
          type: string

    Building:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string

    Event:
      type: object
      properties:
        _id:
          type: string
        assetId:
          type: string
        status:
          type: string
        scheduledAt:
          type: string
          format: date-time

    Intervention:
      type: object
      properties:
        _id:
          type: string
        type:
          type: string
        performedAt:
          type: string
          format: date-time

    Notification:
      type: object
      properties:
        _id:
          type: string
        message:
          type: string
        read:
          type: boolean
